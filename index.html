<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šï¼ˆã‚¹ã‚¯ã‚·ãƒ§è²¼ä»˜ã‘å¯¾å¿œãƒ»é«˜é€Ÿç‰ˆï¼‰</title>

<style>
  body{font-family:Segoe UI, sans-serif; padding:20px; background:#f5f5f5;}
  h1{font-size:1.8rem; margin-bottom:15px; text-align:center;}
  .card{background:white; padding:25px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.08); max-width:750px; margin:0 auto 20px auto;}
  button{padding:10px 20px; border:none; border-radius:10px; cursor:pointer; font-size:1rem; margin-right:10px; margin-top:5px;}
  #pasteBtn{background:#0078ff; color:white;}
  #pasteBtn.flash{animation:flash 0.6s ease-in-out infinite alternate;}
  #clipBtn{background:#28a745; color:white;}
  #resetBtn{background:#dc3545; color:white;}
  .droparea{border:2px dashed #bbb; padding:40px; text-align:center; border-radius:12px; background:white; margin-bottom:20px; font-size:1rem;}
  .droparea.highlight{border-color:#0078ff; background:#eef6ff;}
  img{max-width:100%; margin-top:15px; border-radius:12px;}
  .desc{font-size:1rem; color:#333; line-height:1.7; margin-bottom:10px;}
  .highlight-text{font-weight:bold; font-size:1.2rem; color:#d63384; margin-bottom:15px;}
</style>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.1/umd/index.min.js"></script>
</head>

<body>
<div class="card">
  <h1>QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šï¼ˆã‚¹ã‚¯ã‚·ãƒ§è²¼ä»˜ã‘å¯¾å¿œãƒ»é«˜é€Ÿç‰ˆï¼‰</h1>

  <p class="highlight-text">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã§ <strong>Ctrl + V</strong> ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼</p>

  <p class="desc">
    Ctrl + V ã§è²¼ã‚Šä»˜ã‘<br>
    ã¾ãŸã¯<br>
    QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
  </p>

  <div class="droparea" id="dropArea">
    Ctrl + V ã§è²¼ã‚Šä»˜ã‘<br>ã¾ãŸã¯<br>QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
  </div>

  <img id="preview" style="display:none;" />
  <p id="result" class="desc"></p>

  <p class="desc">ã†ã¾ãè²¼ã‚Šä»˜ã‹ãªã„å ´åˆã¯ã€Œè²¼ä»˜ã‘ã‚’å¾…æ©Ÿã—ã¦é–‹å§‹ã€ã¾ãŸã¯ã€Œã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿å–ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>

  <button id="clipBtn">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿å–ã‚‹</button>
  <button id="pasteBtn">ğŸ“Œ è²¼ä»˜ã‘ã‚’å¾…æ©Ÿã—ã¦é–‹å§‹</button>
  <button id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
let pasteMode = false;

// ========= elements ============
const pasteBtn = document.getElementById('pasteBtn');
const clipBtn = document.getElementById('clipBtn');
const resetBtn = document.getElementById('resetBtn');
const preview = document.getElementById('preview');
const result = document.getElementById('result');
const dropArea = document.getElementById('dropArea');

// ========= è²¼ä»˜ã‘é–‹å§‹ ============
pasteBtn.addEventListener('click', () => {
  pasteMode = true;
  pasteBtn.classList.add('flash');
  pasteBtn.textContent = "ğŸ“¥ Ctrl + V ã‚’å¾…æ©Ÿä¸­â€¦";
});

// ========= ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ ============
clipBtn.addEventListener('click', async () => {
  try {
    const items = await navigator.clipboard.read();
    for (const item of items) {
      if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
        const blob = await item.getType(item.types[0]);
        displayImage(blob);
        return;
      }
    }
  } catch (err) {
    alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTTPSã§é–‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
  }
});

// ========= ãƒªã‚»ãƒƒãƒˆ ============
resetBtn.addEventListener('click', () => {
  preview.src = "";
  preview.style.display = "none";
  result.textContent = "";
  pasteMode = false;
  pasteBtn.classList.remove('flash');
  pasteBtn.textContent = "ğŸ“Œ è²¼ä»˜ã‘ã‚’å¾…æ©Ÿã—ã¦é–‹å§‹";
});

// ========= è²¼ä»˜ã‘ã‚¤ãƒ™ãƒ³ãƒˆ ============
window.addEventListener('paste', (e) => {
  if (!pasteMode) return;

  const items = e.clipboardData.items;
  for (const item of items) {
    if (item.type.indexOf("image") === 0) {
      const blob = item.getAsFile();
      displayImage(blob);
      pasteMode = false;
      pasteBtn.classList.remove('flash');
      pasteBtn.textContent = "ğŸ“Œ è²¼ä»˜ã‘ã‚’å¾…æ©Ÿã—ã¦é–‹å§‹";
      break;
    }
  }
});

// ========= ãƒ‰ãƒ­ãƒƒãƒ— ============
dropArea.addEventListener('dragover', e => {
  e.preventDefault();
  dropArea.classList.add('highlight');
});
dropArea.addEventListener('dragleave', () => {
  dropArea.classList.remove('highlight');
});
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  dropArea.classList.remove('highlight');
  const file = e.dataTransfer.files[0];
  if (file) displayImage(file);
});

// ========= å…±é€šè¡¨ç¤ºå‡¦ç† ============
function displayImage(file){
  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
    preview.style.display = "block";
    decodeQR(reader.result);
  };
  reader.readAsDataURL(file);
}

// ========= QRè§£æï¼ˆjsQR â†’ ZXingï¼‰ ============
async function decodeQR(dataURL){
  result.textContent = "QRã‚³ãƒ¼ãƒ‰ã‚’è§£æä¸­â€¦";

  // ---- ç”»åƒèª­ã¿è¾¼ã¿å¾…ã¡ ----
  await new Promise(r => {
    if (preview.complete) r();
    else preview.onload = r;
  });

  // ---- Canvas ç¸®å°å‡¦ç† ----
  const maxSize = 900;
  const scale = Math.min(maxSize / preview.naturalWidth, maxSize / preview.naturalHeight, 1);
  const w = Math.floor(preview.naturalWidth * scale);
  const h = Math.floor(preview.naturalHeight * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(preview, 0, 0, w, h);
  const imgData = ctx.getImageData(0, 0, w, h);

  // ---- jsQR ----
  try {
    const qr = jsQR(imgData.data, w, h);
    if (qr && qr.data){
      result.innerHTML = `<strong>èª­ã¿å–ã‚Šçµæœï¼ˆjsQRï¼‰:</strong><br><a href="${qr.data}" target="_blank">${qr.data}</a>`;
      return;
    }
  } catch {}

  // ---- ZXingï¼ˆç¸®å°ç‰ˆï¼‰----
  try {
    const luminanceSource = new ZXingBrowser.HTMLCanvasElementLuminanceSource(canvas);
    const bitmap = new ZXingBrowser.BinaryBitmap(new ZXingBrowser.HybridBinarizer(luminanceSource));
    const decoded = ZXingBrowser.BrowserQRCodeReader.decodeBitmap(bitmap);

    if (decoded && decoded.text){
      result.innerHTML = `<strong>èª­ã¿å–ã‚Šçµæœï¼ˆZXingï¼‰:</strong><br><a href="${decoded.text}" target="_blank">${decoded.text}</a>`;
      return;
    }
  } catch {}

  result.textContent = "QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
}

</script>
</body>
</html>
